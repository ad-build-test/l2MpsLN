#This database handles montoring the link node for mode(SC/NC)
#faults and provides functionality to correct them

record(mbbi, "$(P):LCLSMODE_RBV"){
    field(DESC, "Node Timing Mode Readback")
    field(INP, "$(P):LCLSMODE_CALC")
    field(SCAN, "1 second")
    field(ZRST, "NC")
    field(ONST, "SC")
    field(TWST, "Misconfigured")
    field(ZRSV, "NO_ALARM")
    field(ONSV, "NO_ALARM")
    field(TWSV, "MAJOR")
}

record(mbbi, "$(P):LCLSMODE"){
    field(DESC, "Node Timing Mode Set")
    field(ZRST, "NC")
    field(ONST, "SC")
    field(FLNK, "$(P):SET_LCLSMODE")
}

record(calc, $(P):LCLSMODE_CALC){
    field(DESC, "Timing Mode Cacluation")
    field(SCAN, "1 second")
    field(INPA, "TPR:$(LOCA):$(IOC_UNIT):$(INST):MODE") #0 lcls1 1 lcls 2
    field(INPB, "TPR:$(LOCA):$(IOC_UNIT):$(INST):RXLNKSTATUS")# 0 down 1 up
    field(INPC, "$(P):LC1_MODE_RBV") #0 disable 1 enable 
    field(CALC, "(!A)&B&C ? 0 : A&B&(!C) ? 1 : 2")
}

record(fanout, "$(P):SET_LCLSMODE"){
    field(DESC, "Internal")
    field(SCAN, "Passive")
    field(LNK0, "$(P):SET_TPRMODE")
    field(LNK1, "$(P):SET_LC1_MODE")
    field(LNK2, "$(P):SET_CROSSBAR1")
    field(LNK3, "$(P):SET_CROSSBAR2")
}

record(calcout, "$(P):SET_TPRMODE"){
    field(DESC, "Internal")
    field(SCAN, "Passive")
    field(INPA, "$(P):LCLSMODE")
    field(CALC, "!A ? 0 : 1")
    field(OUT, "TPR:$(LOCA):$(IOC_UNIT):$(INST):MODE")
    field(FLNK, "TPR:$(LOCA):$(IOC_UNIT):$(INST):MODE")
}

record(calcout, "$(P):SET_LC1_MODE"){
    field(DESC, "Internal")
    field(SCAN, "Passive")
    field(INPA, "$(P):LCLSMODE")
    field(CALC, "!A ? 1 : 0")
    field(OUT, "$(P):LC1_MODE")
    field(FLNK, "$(P):LC1_MODE")
}

record(calcout, "$(P):SET_CROSSBAR1"){
    field(DESC, "Internal")
    field(SCAN, "Passive")
    field(INPA, "$(P):LCLSMODE")
    field(CALC, "!A ? 0 : 3")
    field(OUT, "$(P):TCRB1:OUTPUTCONFIG") #0 RTM_IN0 (LCLS1), 1 FPGA, 2 BP, 3 RTM_IN1 (LCLS2)
    field(FLNK, "$(P):TCRB1:OUTPUTCONFIG")
}

record(calcout, "$(P):SET_CROSSBAR2"){
    field(DESC, "Internal")
    field(SCAN, "Passive")
    field(INPA, "$(P):LCLSMODE")
    field(CALC, "!A ? 0 : 3")
    field(OUT, "$(P):TCRB2:OUTPUTCONFIG") #0 RTM_IN0 (LCLS1), 1 FPGA, 2 BP, 3 RTM_IN1 (LCLS2)
    field(FLNK, "$(P):TCRB2:OUTPUTCONFIG")
}

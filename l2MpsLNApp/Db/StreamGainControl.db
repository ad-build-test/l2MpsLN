##########################################################################
# Description:
# This database works with LBLM Gain Control Chassis. 
# It adjusts the gain on the analog input through ATCA AMD DAQ channel
#
# Macros:
# DEVICE: Device prefix
# ATTR  : Device attribute  
# PORT  : The asyn port name. It must match the port name given
#         when calling "YCPSWASYNConfig" on st.cmd
# PARAM : The asyn parameter name. It must be defined in the
#         dictionary file and assigned to a register.
##########################################################################
# PV to set amplifier bypass
record(bo, "$(DEVICE):$(ATTR)_AMP_BYP") {
  field(DESC, "Bypass amplifier")
  field(ONAM, "BYPASS")
  field(ZNAM, "NO BYPASS")
  field(FLNK, "$(DEVICE):$(ATTR)_AMP_BYP_SEQ")
  info(autosaveFields, "VAL")
}

# PV to set voltage and gain approritately when amplifier is  bypassed.
# Set Gain to -5.6dB and Voltage to -1.2V
# Notes from Alan Fisher:
# The chassis bypasses the amplifier if the DAC voltage is less than -1 V. There should be a bypass on/off switch that sets the DAC to something about -1.2 V (to be far from the transition). When bypassed, the path attenuates by -5.6 dB
record(seq, "$(DEVICE):$(ATTR)_AMP_BYP_SEQ") {
  field(DESC, "Amplifier Bypass")
  field(DO1, "-5.6")
  field(LNK1, "$(DEVICE):$(ATTR)_AMP_GAIN PP")
  field(DO2, "-1.2")
  field(LNK2, "$(DEVICE):$(ATTR)_AMP_V PP")
  field(ASG,  "Internal")
}
# PV that sets amplifier voltage in register units 
record(ao, "$(DEVICE):$(ATTR)_AMP_V"){
  field(DTYP, "asynInt32")
  field(DESC, "Amplifier Voltage")
  field(LINR, "LINEAR")
  field(PINI, "YES")
  field(EGUL, "-1.67")
  field(EGUF, "1.66")
  field(PREC, "3")
  field(EGU,  "V")
  field(DRVH, "1.6")
  field(DRVL, "-1.6")
  field(OUT,  "@asyn($(PORT),1)$(PARAM)")
  field(SCAN, "Passive")
  field(FLNK, "$(DEVICE):$(ATTR)_AMP_V_RBV")
}

# Readback PV for amplifier voltage in register units 
record(ai, "$(DEVICE):$(ATTR)_AMP_V_RBV"){
  field(DTYP, "asynInt32")
  field(LINR, "LINEAR")
  field(PINI, "YES")
  field(EGUL, "-1.67")
  field(EGUF, "1.66")
  field(PREC, "3")
  field(EGU,  "V")
  field(DESC, "Amplifier Voltage RBV in Volts")
  field(INP,  "@asyn($(PORT),1)$(PARAM)")
  field(SCAN, "1 second")
}

# PV that holds amplifier gain in dB
# When amplifier is bypasses, disable use of this PV.
record(ao, "$(DEVICE):$(ATTR)_AMP_GAIN") {
  field(DESC, "Amplifier Gain Requested")
  field(PINI, "NO")
  field(EGU, "dB")
  field(HOPR, "56.70")
  field(LOPR,"-27.05")
  field(DRVH, "56.70")
  field(DRVL,"-27.05")
  field(SCAN, "Passive")
  field(PREC, "2")
  field(DISV, "1")
  field(SDIS, "$(DEVICE):$(ATTR)_AMP_BYP")
  info(autosaveFields, "VAL")
  field(FLNK, "$(DEVICE):$(ATTR)_AMP_G2V")
}

# PV to enable debug mode for gain to voltage subroutine 
record(bo, "$(DEVICE):$(ATTR)_AMP_DEBUG") {
  field(DESC, "Subroutine Debug")
  field(ONAM, "DEBUG ON")
  field(ZNAM, "DEBUG OFF")
}

# PV to calculate gain to voltage  
record(aSub, "$(DEVICE):$(ATTR)_AMP_G2V") {
  field(DESC, " V calc Subroutine")
  field(INAM, "aInit")
  field(SNAM, "calcG2V")
  field(INPA, "$(DEVICE):$(ATTR)_AMP_GAIN PP")
  field(INPB, "$(DEVICE):$(ATTR)_AMP_DEBUG")
  field(OUTA, "$(DEVICE):$(ATTR)_AMP_V")
  field(FLNK, "$(DEVICE):$(ATTR)_AMP_V")
  field(PREC, "2")
  info(autosaveFields, "INPA")
}
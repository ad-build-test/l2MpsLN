#!/bin/sh

# Read the backplane clock setting
printf "Reading the initial setting...\n"
printf "Slot 2: "
ipmitool -I lan -H $1 -t 0x84 -b 0 -A NONE raw 0x2e 0x38 0x0a 0x40 0x00 0x00 0x00 0x31
printf "Slot 3: "
ipmitool -I lan -H $1 -t 0x86 -b 0 -A NONE raw 0x2e 0x38 0x0a 0x40 0x00 0x00 0x00 0x31
printf "Slot 4: "
ipmitool -I lan -H $1 -t 0x88 -b 0 -A NONE raw 0x2e 0x38 0x0a 0x40 0x00 0x00 0x00 0x31
printf "Slot 5: "
ipmitool -I lan -H $1 -t 0x8a -b 0 -A NONE raw 0x2e 0x38 0x0a 0x40 0x00 0x00 0x00 0x31
printf "Slot 6: "
ipmitool -I lan -H $1 -t 0x8c -b 0 -A NONE raw 0x2e 0x38 0x0a 0x40 0x00 0x00 0x00 0x31
printf "Slot 7: "
ipmitool -I lan -H $1 -t 0x8e -b 0 -A NONE raw 0x2e 0x38 0x0a 0x40 0x00 0x00 0x00 0x31
printf "Done!\n\n"

# Setup the backplane clock (slot 2: TX, slots 2-7: RX)
printf "Setting up the clock...\n"
printf "Slot 2 (TX): "
ipmitool -I lan -H $1 -t 0x84 -b 0 -A NONE raw 0x2e 0x39 0x0a 0x40 0x00 0x00 0x00 0x31 0x01
printf "Slot 3 (RX): "
ipmitool -I lan -H $1 -t 0x86 -b 0 -A NONE raw 0x2e 0x39 0x0a 0x40 0x00 0x00 0x00 0x31 0x00
printf "Slot 4 (RX): "
ipmitool -I lan -H $1 -t 0x88 -b 0 -A NONE raw 0x2e 0x39 0x0a 0x40 0x00 0x00 0x00 0x31 0x00
printf "Slot 5 (RX): "
ipmitool -I lan -H $1 -t 0x8a -b 0 -A NONE raw 0x2e 0x39 0x0a 0x40 0x00 0x00 0x00 0x31 0x00
printf "Slot 6 (RX): "
ipmitool -I lan -H $1 -t 0x8c -b 0 -A NONE raw 0x2e 0x39 0x0a 0x40 0x00 0x00 0x00 0x31 0x00
printf "Slot 7 (RX): "
ipmitool -I lan -H $1 -t 0x8e -b 0 -A NONE raw 0x2e 0x39 0x0a 0x40 0x00 0x00 0x00 0x31 0x00
printf "Done!\n\n"

# Readback the backplane clock setting
printf "Reading back the setting...\n"
printf "Slot 2: "
ipmitool -I lan -H $1 -t 0x84 -b 0 -A NONE raw 0x2e 0x38 0x0a 0x40 0x00 0x00 0x00 0x31
printf "Slot 3: "
ipmitool -I lan -H $1 -t 0x86 -b 0 -A NONE raw 0x2e 0x38 0x0a 0x40 0x00 0x00 0x00 0x31
printf "Slot 4: "
ipmitool -I lan -H $1 -t 0x88 -b 0 -A NONE raw 0x2e 0x38 0x0a 0x40 0x00 0x00 0x00 0x31
printf "Slot 5: "
ipmitool -I lan -H $1 -t 0x8a -b 0 -A NONE raw 0x2e 0x38 0x0a 0x40 0x00 0x00 0x00 0x31
printf "Slot 6: "
ipmitool -I lan -H $1 -t 0x8c -b 0 -A NONE raw 0x2e 0x38 0x0a 0x40 0x00 0x00 0x00 0x31
printf "Slot 7: "
ipmitool -I lan -H $1 -t 0x8e -b 0 -A NONE raw 0x2e 0x38 0x0a 0x40 0x00 0x00 0x00 0x31
printf "Done!\n\n"
